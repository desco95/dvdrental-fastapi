name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  POSTGRES_IMAGE: dvdrental-postgres
  API_IMAGE: dvdrental-api

jobs:
  # Job 1: Build y Test
  build-and-test:
    name: Build & Test API
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build PostgreSQL image
      run: |
        docker build -t $POSTGRES_IMAGE:test ./postgres

    - name: ğŸ—ï¸ Build API image
      run: |
        docker build -t $API_IMAGE:test ./backend

    - name: ğŸš€ Start services
      run: |
        docker network create dvdrental-test
        
        # Iniciar PostgreSQL
        docker run -d \
          --name postgres-test \
          --network dvdrental-test \
          -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=postgres \
          -e POSTGRES_DB=dvdrental \
          $POSTGRES_IMAGE:test
        
        # Esperar a PostgreSQL
        echo "Waiting for PostgreSQL..."
        for i in {1..30}; do
          if docker exec postgres-test pg_isready -U postgres -d dvdrental; then
            echo "PostgreSQL is ready!"
            break
          fi
          echo "Attempt $i/30..."
          sleep 2
        done
        
        # Iniciar API
        docker run -d \
          --name api-test \
          --network dvdrental-test \
          -e DB_HOST=postgres-test \
          -e DB_PORT=5432 \
          -e DB_USER=postgres \
          -e DB_PASSWORD=postgres \
          -e DB_NAME=dvdrental \
          -p 8000:8000 \
          $API_IMAGE:test
        
        # Esperar a la API
        echo "Waiting for API..."
        sleep 20

    - name: ğŸ§ª Run tests
      run: |
        chmod +x test-api.sh
        export API_URL=http://localhost:8000
        ./test-api.sh

    - name: ğŸ“Š Show logs if failed
      if: failure()
      run: |
        echo "=== PostgreSQL Logs ==="
        docker logs postgres-test
        echo ""
        echo "=== API Logs ==="
        docker logs api-test

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        docker stop postgres-test api-test || true
        docker rm postgres-test api-test || true
        docker network rm dvdrental-test || true

  # Job 2: Push to Docker Hub (solo en main)
  push-images:
    name: Push to Docker Hub
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ğŸ—ï¸ Build and push PostgreSQL
      uses: docker/build-push-action@v5
      with:
        context: ./postgres
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.POSTGRES_IMAGE }}:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.POSTGRES_IMAGE }}:${{ github.sha }}

    - name: ğŸ—ï¸ Build and push API
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.API_IMAGE }}:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.API_IMAGE }}:${{ github.sha }}

  # Job 3: NotificaciÃ³n de resultados
  notify:
    name: Notify Results
    needs: [build-and-test, push-images]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: âœ… Success notification
      if: needs.build-and-test.result == 'success'
      run: |
        echo "ğŸ‰ All tests passed!"
        echo "âœ… Build: SUCCESS"
        echo "âœ… Tests: PASSED"
        if [ "${{ needs.push-images.result }}" == "success" ]; then
          echo "âœ… Images pushed to Docker Hub"
        fi

    - name: âŒ Failure notification
      if: needs.build-and-test.result == 'failure'
      run: |
        echo "âŒ Pipeline failed!"
        echo "Check the logs above for details"
        exit 1